---
###############################################
# PLAY 1 — Provision VM on Proxmox (cloud-init)
###############################################
- name: Provision VM on Proxmox and deploy app
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # ===== Proxmox API =====
    proxmox_api_host: 10.13.104.216
    proxmox_api_user: root@pam
    proxmox_api_password: int53106
    proxmox_node: int531-06

    # ===== Template & VM config =====
    vm_template: "ubuntu-2404-cloudinit"
    vm_name: "bjg-demo-vm"
    vm_hostname: "bjg-demo-vm"

    vm_ip: 10.13.104.150
    vm_cidr: 24
    vm_gw: 10.13.104.254

    # ===== Cloud-init user (ให้ตรงกับ template ของคุณ) =====
    cloudinit_user: dev

    # ===== SSH key (macOS) =====
    ansible_ssh_key_path: "/Users/niraphan/.ssh/ansible_key"

    # ===== App config =====
    app_dir: /opt/myapp
    app_repo: "https://github.com/9INEJAMES/int531-demo-project.git"

  tasks:
    - name: Read SSH public key (from macOS)
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ lookup('file', ansible_ssh_key_path + '.pub') }}"

    - name: Create VM from cloud-init template (clone + inject ssh key + set IP/GW)
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        node: "{{ proxmox_node }}"

        clone: "{{ vm_template }}"
        name: "{{ vm_name }}"
        full: true
        timeout: 300

        # cloud-init settings
        ciuser: "{{ cloudinit_user }}"
        sshkeys: "{{ ssh_pubkey }}"
        ipconfig:
          ipconfig0: "ip={{ vm_ip }}/{{ vm_cidr }},gw={{ vm_gw }}"
      register: created_vm

    - name: Start new VM
      community.proxmox.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        api_host: "{{ proxmox_api_host }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ created_vm.vmid }}"
        state: started

    - name: Wait for SSH port open on VM
      ansible.builtin.wait_for:
        host: "{{ vm_ip }}"
        port: 22
        delay: 10
        timeout: 300

    # ✅ กันอาการ SSH ยังไม่ ready (kex reset) โดยเช็กเข้าได้จริง
    - name: Wait until SSH login works
      ansible.builtin.command: >
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
        -i {{ ansible_ssh_key_path }}
        {{ cloudinit_user }}@{{ vm_ip }} "echo ready"
      register: ssh_ready
      retries: 20
      delay: 6
      until: ssh_ready.rc == 0
      changed_when: false

    - name: Register new VM as dynamic host
      ansible.builtin.add_host:
        name: new_vm
        ansible_host: "{{ vm_ip }}"
        ansible_user: "{{ cloudinit_user }}"
        ansible_ssh_private_key_file: "{{ ansible_ssh_key_path }}"
        ansible_python_interpreter: /usr/bin/python3
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        groups: provisioned

    - name: Show created VMID
      ansible.builtin.debug:
        msg: "Created VM with VMID {{ created_vm.vmid }} on {{ proxmox_node }}"

###########################################################
# PLAY 2 — Install Docker + Deploy app via docker compose
###########################################################
- name: Configure new VM and deploy app
  hosts: new_vm
  become: yes
  gather_facts: yes

  vars:
    app_dir: /opt/myapp
    app_repo: "https://github.com/9INEJAMES/int531-demo-project.git"

    # demo ports (พอจำเป็นให้รันได้)
    ufw_allow_ports:
      - "22"
      - "80"
      - "8000"
      - "8001"
      - "8443"

  tasks:
    - name: Wait for cloud-init to complete
      ansible.builtin.command: cloud-init status --wait
      changed_when: false
      failed_when: false

    - name: Wait for apt lock to be released
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 ; do
          echo "Waiting for apt lock..."
          sleep 5
        done
      args:
        executable: /bin/bash
      changed_when: false

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 600

    - name: Install base tools (git, curl, gnupg, ca-certificates, ufw)
      ansible.builtin.apt:
        name:
          - git
          - ca-certificates
          - curl
          - gnupg
          - ufw
        state: present

    #################################################
    # UFW: allow incoming all (ตามที่เคยขอ) + เปิดพอร์ตหลัก
    #################################################
    - name: UFW - set default incoming policy to ALLOW (⚠️ allow all)
      community.general.ufw:
        direction: incoming
        policy: allow

    - name: UFW - set default outgoing policy to ALLOW
      community.general.ufw:
        direction: outgoing
        policy: allow

    - name: UFW - allow required ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: "{{ ufw_allow_ports }}"

    - name: UFW - enable
      community.general.ufw:
        state: enabled

    #################################################
    # Docker install
    #################################################
    - name: Ensure keyrings directory exists for Docker
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker GPG key
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        executable: /bin/bash
        creates: /etc/apt/keyrings/docker.gpg

    - name: Get system architecture for Docker repo
      ansible.builtin.command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Add Docker APT repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
        state: present
        filename: docker
        update_cache: yes

    - name: Install Docker engine and compose plugin
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Ensure Docker daemon is enabled and running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Add dev user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    #################################################
    # Deploy app (use repo compose)
    #################################################
    - name: Ensure app directory exists
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Clone app repo
      ansible.builtin.git:
        repo: "{{ app_repo }}"
        dest: "{{ app_dir }}"
        update: yes
        force: yes
        version: HEAD
      become: yes
      become_user: "{{ ansible_user }}"

    - name: Docker compose up (build + detached) from repo (apply docker group immediately)
      ansible.builtin.shell: |
        set -e
        cd {{ app_dir }}
        sg docker -c "docker compose up -d --build"
      args:
        executable: /bin/bash
      become: yes
      become_user: "{{ ansible_user }}"
      register: compose_up


    - name: Show compose output
      ansible.builtin.debug:
        var: compose_up.stdout_lines

    #################################################
    # Verify (กันผ่านหลอก)
    #################################################
    - name: Wait until containers exist and are running
      ansible.builtin.shell: |
        set -e
        cd {{ app_dir }}
        sg docker -c "docker compose ps"
      args:
        executable: /bin/bash
      become: yes
      become_user: "{{ ansible_user }}"
      register: compose_ps
      retries: 20
      delay: 6
      until: "'running' in compose_ps.stdout"
      changed_when: false

    - name: Quick HTTP checks (inside VM)
      ansible.builtin.shell: |
        set -e
        curl -fsS http://127.0.0.1/ >/dev/null
        curl -fsS http://127.0.0.1:8000/ >/dev/null
      args:
        executable: /bin/bash
      become: yes
      changed_when: false
